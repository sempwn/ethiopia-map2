function Person(e,a){this.b=s.gamma(e,a),this.M=.5,this.W=0,this.WM=0,this.WF=0,this.I=0,this.bednet=0,this.t=0,this.u=s.normal(params.u0,Math.sqrt(params.sigma)),this.repRate=function(){return 0==params.nu?this.WM>0?this.WF:0:params.alpha*Math.min(this.WF,1/params.nu*this.WM)},this.biteRate=function(){return this.a<108?this.a/108:1},this.react=function(){var e=1-(1-params.sN)*this.bedNet;this.I=immuneRK4Step(this.W,this.I);var a=poisson(.5*e*params.xi*this.biteRate()*params.L3*Math.exp(-1*params.theta*this.I)*this.b*params.dt),t=poisson(params.mu*this.WM*params.dt);this.WM+=a-t,a=poisson(.5*e*params.xi*this.biteRate()*params.L3*Math.exp(-1*params.theta*this.I)*this.b*params.dt),t=poisson(params.mu*this.WF*params.dt),this.WF+=a-t,this.M+=params.dt*(this.repRate()-params.gamma*this.M),this.W=this.WM+this.WF,this.t+=params.dt,this.a+=params.dt,this.W<0&&(this.W=0),this.WM<0&&(this.WM=0),this.WF<0&&(this.WF=0),this.I<0&&(this.I=0),this.M<0&&(this.M=0),(Math.random()<1-Math.exp(-1*params.tau*params.dt)||this.a>1200)&&(this.initialise(),this.a=0)},this.initialise=function(){this.W=0,this.WM=0,this.WF=0,this.I=0,this.M=0,this.bedNet=0,this.u=s.normal(params.u0,Math.sqrt(params.sigma))}}function Model(e){this.sU=0,this.sB=0,this.sN=0,this.people=[],this.n=e,this.bedNetInt=0,this.ts=[],this.Ms=[],this.Ws=[],this.Ls=[];for(var a=0;e>a;a++)this.people.push(new Person(params.a,params.b));this.saveOngoing=function(e,a,t,s){s=1-Math.exp(-s),this.ts.push(e),this.Ms.push(100*a),this.Ws.push(100*t),this.Ls.push(100*s)},this.L3=function(){for(var e=0,a=0,t=0;t<this.n;t++)e+=this.people[t].b*L3Uptake(this.people[t].M),a+=this.people[t].b;return e/=a,e*(1+this.bedNetInt*params.covN*(params.sN-1))*params.lbda*params.g/(params.sig+params.lbda*params.psi1)},this.prevalence=function(){for(var e=0,a=0;a<this.n;a++)e+=s.random()<1-Math.exp(-this.people[a].M);return e/this.n},this.aPrevalence=function(){for(var e=0,a=0;a<this.n;a++)e+=this.people[a].W>0;return e/this.n},this.MDAEvent=function(){for(var e=0;e<this.n;e++)s.normal(this.people[e].u,1)<0&&(this.people[e].M=params.mfPropMDA*this.people[e].M,this.people[e].WM=Math.floor(params.wPropMDA*this.people[e].WM),this.people[e].WF=Math.floor(params.wPropMDA*this.people[e].WF))},this.bedNetEvent=function(){params.sig=params.sig+params.lbda*params.dN*params.covN;for(var e=0;e<this.n;e++)this.people[e].bedNet=s.random()<params.covN?1:0},this.nRounds=function(){for(var e=[],a=0;a<this.Ms.length;a++)this.Ms[a]<1&&e.push(a);return Math.floor(12==params.mdaFreq?this.ts[e[0]]:2*this.ts[e[0]])},this.reduction=function(e){var a=6*e;return this.Ms[a]/this.Ms[0]},this.reductionYears=function(){for(var e=[],a=0;20>a;a++)e.push(this.reduction(a));return e},this.evolveAndSaves=function(e){var a,t=0,s=0,r=1200;this.bedNetInt=0;for(var i=0;i<this.n;i++)this.people[i].M=1;for(r=1200+params.nMDA*params.mdaFreq,a=1==params.IDAControl?1200+5*params.mdaFreq:2*r,console.log("mosquito species: ",params.mosquitoSpecies,"\n"),params.L3=5,console.log("0----------100\n-");12*e>t;){params.dt=960>t?12:1;for(var i=0;i<this.n;i++)this.people[i].react();t=this.people[0].t,params.L3=960>t?2:this.L3(),t%2==0&&t<Math.floor(t)+params.dt&&this.saveOngoing(t/12,this.prevalence(),this.aPrevalence(),params.L3),Math.floor(t)%Math.floor(12*e/10)==0&&t<Math.floor(t)+params.dt&&(console.log("-"),$("#test1").append(" p : "+this.prevalence()+" t : "+t/12)),t>=1200&&t<1200+params.dt&&(console.log("bednet event at ",t),this.bedNetEvent(),this.bedNetInt=1),t%params.mdaFreq==0&&t<Math.floor(t)+params.dt&&(t>1200&&r>=t?(this.MDAEvent(),setBR(!0),setVH(!0),setMu(!0)):(setBR(!1),setVH(!1),setMu(!1))),s++}this.Ws=this.Ws.slice(200,this.Ws.length),this.Ms=this.Ms.slice(200,this.Ms.length),this.Ls=this.Ls.slice(200,this.Ls.length);var o=this.ts[200];this.ts=math.subtract(this.ts.slice(200,this.ts.length),o)}}function NormSInv(e){var a,t,s,r=-39.6968302866538,i=220.946098424521,o=-275.928510446969,n=138.357751867269,l=-30.6647980661472,d=2.50662827745924,c=-54.4760987982241,m=161.585836858041,p=-155.698979859887,u=66.8013118877197,h=-13.2806815528857,v=-.00778489400243029,f=-.322396458041136,g=-2.40075827716184,b=-2.54973253934373,S=4.37466414146497,$=2.93816398269878,M=.00778469570904146,y=.32246712907004,x=2.445134137143,D=3.75440866190742,C=.02425,w=1-C;return 0>e||e>1?(console.error("NormSInv: Argument out of range."),s=0):C>e?(a=Math.sqrt(-2*Math.log(e)),s=(((((v*a+f)*a+g)*a+b)*a+S)*a+$)/((((M*a+y)*a+x)*a+D)*a+1)):e>w?(a=Math.sqrt(-2*Math.log(1-e)),s=-(((((v*a+f)*a+g)*a+b)*a+S)*a+$)/((((M*a+y)*a+x)*a+D)*a+1)):(a=e-.5,t=a*a,s=(((((r*t+i)*t+o)*t+n)*t+l)*t+d)*a/(((((c*t+m)*t+p)*t+u)*t+h)*t+1)),s}function toggle(e,a){var t=$(a);t.prop("checked")?$(e).show():$(e).hide()}function toggleOff(e,a){var t=$(a);t.prop("checked")?$(e).hide():$(e).show()}function modelParams(){return{mda:$("#inputMDARounds").val(),mdaSixMonths:$("input:radio[name=mdaSixMonths]:checked").val(),endemicity:$("#endemicity").val(),coverage:$("#MDACoverage").val(),covN:$("#bedNetCoverage").val(),v_to_hR:$("#insecticideCoverage").val(),rho:$("#sysAdherence").val(),vecCap:$("#vectorialCapacity").val(),vecComp:$("#vectorialCompetence").val(),vecD:$("#vectorialDeathRate").val(),mdaRegimen:$("input[name=mdaRegimenRadios]:checked").val(),sysComp:$("#sysAdherence").val(),rhoBComp:$("#brMda").val(),rhoCN:$("#bedNetMda").val(),species:$("input[name=speciesRadios]:checked").val(),macrofilaricide:$("#Macrofilaricide").val(),microfilaricide:$("#Microfilaricide").val()}}function mdaDrugName(e){var a="";switch(e){case"1":a="albendazole + ivermectin";break;case"2":a="albendazole + diethylcarbamazine";break;case"3":a="ivermectin";break;case"4":a="ivermectin + diethylcarbamazine + albendazole";break;case"5":a="custom regimen with "+$("#Macrofilaricide").val()+"% macrofilariae reduction, and "+$("#Microfilaricide").val()+"% microfilariae reduction"}return a}function paramSummary(e){void 0===e&&(e=""),str=paramSummaryText(!1),$("#model"+e+" #parameters-summary").text(str)}function paramSummaryText(e){e=void 0!==e?e:!1;var a=modelParams(),t="Parameters used in this scenario are : ";return e===!1?(t+=a.mda?a.mda+" rounds ":"no MDA rounds ",a.mda&&(t+="of "+mdaDrugName(a.mdaRegimen)+" MDA "),a.mda&&(t+="True"==a.mdaSixMonths?"occuring every six months ":"occuring annually "),t+=a.mda?"with "+a.coverage+"% coverage. ":". "):(t+=mdaDrugName(a.mdaRegimen),t+=a.mdaSixMonths?" occuring every six months ":" occuring annually ",t+="with "+a.coverage+"% coverage. "),t+="Prevalence of microfilariaemia is on average "+a.endemicity+"%. ",t+="Bed-net coverage is "+a.covN+"% and ",t+="insecticide coverage is "+a.v_to_hR+"%. "}function multiSimCompute(e){void 0===e&&(e=""),setInputParams();var a=new Model(800);a.evolveAndSaves(120),$("#model"+e+" #test-data-result").html(a),$("#pleaseWaitDialog").modal("hide");var t=+$("#model"+e+" #multiSim").val();$(".progress-bar").css("width","0%").attr("aria-valuenow",0);var s={x:a.ts,y:a.Ms,type:"scatter",name:"run "+t},r={x:a.ts,y:a.Ws,type:"scatter",name:"run "+t},i={x:a.ts,y:a.Ls,type:"scatter",name:"run "+t},o=jQuery.extend({},layout);o.title="microfilariaemia",Plotly.newPlot("model_"+e+"_chart_mf",[s],o,{displayModeBar:!1}),$("#model_"+e+"_chart_mf,#model_"+e+"_chart_wb,#model_"+e+"_chart_L3").on("plotly_beforehover",function(){return!1});var n=jQuery.extend({},layout);n.title="antigenaemia",Plotly.newPlot("model_"+e+"_chart_wb",[r],n,{displayModeBar:!1});var l=jQuery.extend({},layout);l.title="mosquito",Plotly.newPlot("model_"+e+"_chart_L3",[i],l,{displayModeBar:!1}),addNewSim($("#model"+e+" #multiSim").val()-1,e,t)}function addNewSim(e,a,t){if(void 0===a&&(a=""),e>0){setInputParams();var s=new Model(800);s.evolveAndSaves(120);var r={x:s.ts,y:s.Ms,type:"scatter",name:"run "+e},i={x:s.ts,y:s.Ws,type:"scatter",name:"run "+e},o={x:s.ts,y:s.Ls,type:"scatter",name:"run "+e};Plotly.addTraces("model_"+a+"_chart_mf",r),Plotly.addTraces("model_"+a+"_chart_wb",i),Plotly.addTraces("model_"+a+"_chart_L3",o),$(".progress-bar").css("width",100*(t-e+1)/t+"%").attr("aria-valuenow",100*(t-e+1)/t),e--,setTimeout(function(){addNewSim(e,a,t)},500)}else $("#model"+a+" #multiSimLoading").hide()}function runSimulation(e){if(paramSummary(e),$("#model"+e+" #mutliSimCheckBox").prop("checked"))$("#model"+e+" #multiSimLoading").show(),multiSimCompute(e);else{setInputParams();var a=new Model(800);a.evolveAndSaves(120);var t={x:a.ts,y:a.Ms,type:"scatter",name:"microfilariaemia"},s={x:a.ts,y:a.Ws,type:"scatter",name:"antigenaemia"},r={x:a.ts,y:a.Ls,type:"scatter",name:"mosquito"},i=[t,s,r];layout.title="Time Series",Plotly.newPlot("plotlyChart"+e,i,layout,{displayModeBar:!1})}}function SessionData(){}function ScenarioIndex(){}function clearSession(){bootbox.confirm("Are you sure you want to delete this session? This will remove all scenarios.",function(e){e&&(SessionData.deleteSession(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawMap(),drawComparisonPlot(),$("#scenario-title").html("Scenario Overview"))})}function scenarioComparisonSelectVisibility(){var e=SessionData.retrieveSession(),a=e&&e.scenarios?e.scenarios.length:0;a>0?$("#sel-comp-stat-div").show():$("#sel-comp-stat-div").hide()}function scenarioRunStats(){var e=ScenarioIndex.getIndex(),a=($.Deferred(),[]);d3.json("./assets/EthiopiaSimplify.json",function(t,s){for(var r=[],i=[],o=0;20>o;o++){cLow=SessionData.reductions(e,Math.floor(o),"low"),cMedium=SessionData.reductions(e,Math.floor(o),"medium"),cHigh=SessionData.reductions(e,Math.floor(o),"high");var n=reductionStatsCalc(s,cLow,cMedium,cHigh,params.covMDA);i.push(n.doses),r.push(o),a.push(100*(1-n.reduction))}console.log(r),console.log(i),SessionData.storeStats({ts:r,prev_reds:a,doses:i}),drawComparisonPlot()})}function createScenarioBoxes(){var e=SessionData.retrieveSession(),a=ScenarioIndex.getIndex();n=e&&e.scenarios?e.scenarios.length:0,d3.select("#scenario-button-group").html(""),n>0&&d3.select("#scenario-button-group").append("h4").html("Select scenario to map:");for(var t=0;n>t;t++)d3.select("#scenario-button-group").append("div").attr("class","btn btn-primary btn-lg btn-block ".concat(t==a?"active":"")).attr("id","scenario-button-"+t).attr("data-scenario-label",e.scenarios[t].label).attr("data-scenario",t).attr("aria-pressed",t==a).html(e.scenarios[t].label).on("click",function(){ScenarioIndex.setIndex($("#"+this.id).data("scenario")),setmodelParams(),fixInput(),drawMap(),$("#close_scenario").html("show scenario"),$("#scenario-messages").html('<div class="alert alert-success alert-dismissible" role="alert">  '+$("#"+this.id).data("scenario-label")+" set </div>"),$(this).addClass("active").siblings().removeClass("active"),$("#delete_scenario").removeClass("hidden").unbind().click(function(){bootbox.confirm("Are you sure you want to delete this scenario?",function(e){e&&(SessionData.deleteScenario(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),drawMap(),$("#settings-modal").modal("hide"))})}),$("#settings-modal").modal("show"),$("#run_scenario").html(SessionData.ran(t)?"Display Scenario":"Run Scenario")});n>0&&(d3.select("#scenario-button-group").append("div").attr("class","divider"),d3.select("#scenario-button-group").append("div").attr("class","btn btn-danger btn-lg btn-block ").html("Clear Session").on("click",clearSession))}function drawComparisonPlot(){var e=SessionData.retrieveSession();if(e.scenarios.length>0){var a=$("#sel-comp-stat").val();"doses"==a?drawDosesTimeLine():"rounds"==a?drawMapBoxPlot():"prev"==a&&drawPrevalenceTimeLine()}else Plotly.newPlot("map-boxplot",[],{height:10,width:10},{displayModeBar:!1})}function drawDosesTimeLine(){for(var e=ScenarioIndex.getIndex(),a=SessionData.retrieveSession(),t=a.scenarios.length,s=[],r={autosize:!0,title:"Doses per year",xaxis:{title:"time since start of intervention (yrs)",showgrid:!0,zeroline:!1},yaxis:{title:"doses",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},i=0;t>i;i++){var o=a.scenarios[i].stats.ts,n=a.scenarios[i].stats.doses,l={x:o,y:n,mode:"lines+markers",name:a.scenarios[i].label};s.push(l)}console.log(s),Plotly.newPlot("map-boxplot",s,r,{displayModeBar:!1}),ScenarioIndex.setIndex(e)}function drawPrevalenceTimeLine(){for(var e=ScenarioIndex.getIndex(),a=SessionData.retrieveSession(),t=a.scenarios.length,s=[],r={autosize:!0,title:"Reduction in Prevalence (%)",xaxis:{title:"time since start of intervention (yrs)",showgrid:!0,zeroline:!1},yaxis:{title:"Reduction in prevalence (%)",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},i=0;t>i;i++){var o=a.scenarios[i].stats.ts,n=a.scenarios[i].stats.prev_reds,l={x:o,y:n,mode:"lines+markers",name:a.scenarios[i].label};s.push(l)}Plotly.newPlot("map-boxplot",s,r,{displayModeBar:!1}),ScenarioIndex.setIndex(e)}function drawMapBoxPlot(){for(var e=SessionData.retrieveSession(),a=e.scenarios.length,t=[],s=0;a>s;s++){var r={y:SessionData.nRounds(s),type:"box",name:e.scenarios[s].label};t.push(r)}var i={autosize:!0,title:"No. rounds to below 1% microfilariaemia",xaxis:{title:"",showgrid:!1,zeroline:!1},yaxis:{title:"No. rounds",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}};Plotly.newPlot("map-boxplot",t,i,{displayModeBar:!1})}function createTimeLine(){var e=d3.select("#tooltip"),a=d3.select("#map-outputs").select("h4");d3.json("./assets/EthiopiaSimplify.json",function(t,s){d3.select("#slider1").call(d3.slider().axis(!0).min(2016).max(2035).step(1).on("slide",function(t,r){r-=2016;var i=ScenarioIndex.getIndex(),o=SessionData.reductions(i,Math.floor(r)),n=SessionData.reductions(i,Math.floor(r),"low"),l=SessionData.reductions(i,Math.floor(r),"medium"),d=SessionData.reductions(i,Math.floor(r),"high");stats=reductionStatsCalc(s,n,l,d,params.covMDA),a.html(r+" years after intervention, "+Math.round(100*(1-stats.reduction))+"% reduction, "+numberWithCommas(Math.round(stats.doses))+" doses given. "),d3.selectAll("path").attr("class",function(e,a){return a<glob_prevs.length?colorIU(s.features[a].properties.endemicity,s.features[a].properties.prev,s.features[a].properties.pop,n,l,d):colorIU(0,0,0,0,0,0)}).on("mousemove",function(a,t){e.style("visibility","visible").html("<h5 class='text-center'> "+s.features[t].properties.ADMIN1+", "+s.features[t].properties.ADMIN2+", "+s.features[t].properties.ADMIN3+", prevalence : "+Math.round(100*s.features[t].properties.prev*o)+"%. Population size : "+numberWithCommas(Math.round(s.features[t].properties.pop))+" </h5>")})}))})}function resetSlider(){d3.select("#slider-div").html(""),d3.select("#map-outputs h4").html(""),d3.select("#slider-div").append("div").attr("id","slider1"),createTimeLine()}function numberWithCommas(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")}function runMapSimulation(){setInputParams({nMDA:40});var e=$("#inputScenarioLabel").val(),a=100,t=[],s=0;fixInput(),$("#map-progress-bar").css("width","0%"),$("#map-progress-bar").show();var r=setInterval(function(){$("#map-progress-bar").css("width",+(100*s/a)+"%"),a/3>s?(endemicity="low",setInputParams({endemicity:5,nMDA:40})):2*a/3>s?(endemicity="medium",setInputParams({endemicity:10,nMDA:40})):(endemicity="high",setInputParams({endemicity:15,nMDA:40}));var i=new Model(800);i.evolveAndSaves(120),t.push(SessionData.convertRun(i,endemicity)),$("#roundsTest").html(100*s/a+"%"),s==a?($("#map-progress-bar").hide(),clearInterval(r),SessionData.storeResults(t,e),scenarioRunStats(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawMap(),$("#scenario-title").html(e+" Overview"),$("#settings-modal").modal("hide")):s+=1},10)}function reductionStatsCalc(e,a,t,s,r){for(var i=e.features.length,o=0,n=0,l=0,d="",c=6==params.mdaFreq?2:1,m=0;i>m;m++)d=e.features[m].properties.endemicity,prev=e.features[m].properties.prev,pop=e.features[m].properties.pop,"low"==d?(n+=a,o+=1,prev*a>.01&&(l+=pop*r*c)):"medium"==d?(n+=t,o+=1,prev*t>.01&&(l+=pop*r*c)):"high"==d&&(n+=s,o+=1,prev*s>.01&&(l+=pop*r*c));return{reduction:n/o,doses:l}}function colorIU(e,a,t,s,r,i){var o=$("#sel-stat").val(),n=params.covMDA,l=0;"low"==e?(rPrev=a*s,pTAS=.01>a*s,a*s>.01&&(l=t*n)):"medium"==e?(rPrev=a*r,pTAS=.01>a*r,a*r>.01&&(l=t*n)):"high"==e?(rPrev=a*i,pTAS=.01>a*i,a*i>.01&&(l=t*n)):(l=0,pTAS=1,rPrev=0);var d;if("prev"==o)d=quantize(rPrev);else if("pTAS"==o)d=quantizeTAS(pTAS);else if("doses"==o)d=quantizeDoses(l);else var d=quantize(0);return"iu "+d}function modalConfirmation(e){SessionData.ran(e)?(ScenarioIndex.setIndex(e),$("#settings-modal").modal("hide")):runSimClick()}function addScenarioButton(){var e=SessionData.numScenarios();ScenarioIndex.setIndex(e),SessionData.createNewSession(),$("#scenario-messages").html(""),$("#delete_scenario").addClass("hidden"),$("#settings-modal").modal("show"),$("#close_scenario").html("close"),fixInput(!1)}function runSimClick(){runMapSimulation();d3.select("#map-outputs").select("h4")}function drawMap(){d3.json("./assets/EthiopiaSimplify.json",function(e,a){d3.selectAll("path").attr("class",function(e,t){return t<glob_prevs.length?colorIU(a.features[t].properties.endemicity,a.features[t].properties.prev,a.features[t].properties.pop,1,1,1):colorIU(0,0,0,0,0,0)}).on("mousemove",function(e,t){d3.select("#tooltip").style("visibility","visible").html("<h5 class='text-center'> "+a.features[t].properties.ADMIN1+", "+a.features[t].properties.ADMIN2+", "+a.features[t].properties.ADMIN3+", prevalence : "+Math.round(100*a.features[t].properties.prev)+"%. Population size : "+numberWithCommas(Math.round(a.features[t].properties.pop))+" </h5>")})}),SessionData.ran(ScenarioIndex.getIndex())&&resetSlider()}function fixInput(e){var a=ScenarioIndex.getIndex();null==e&&(e=!0),e?($("#MDACoverage").slider("disable"),$("#bedNetCoverage").slider("disable"),$("#insecticideCoverage").slider("disable"),$("#Microfilaricide").slider("disable"),$("#Macrofilaricide").slider("disable"),$("#sysAdherence").slider("disable"),$("#run_scenario").hide(),$("input:radio[name=mdaSixMonths]").attr("disabled",!0),$("input:radio[name=mdaRegimenRadios]").attr("disabled",!0),$("#inputScenarioLabel").attr("disabled",!0)):($("#MDACoverage").slider("enable"),$("#bedNetCoverage").slider("enable"),$("#insecticideCoverage").slider("enable"),$("#Microfilaricide").slider("enable"),$("#Macrofilaricide").slider("enable"),$("#sysAdherence").slider("enable"),$("#run_scenario").show(),$("input:radio[name=mdaSixMonths]").attr("disabled",!1),$("input:radio[name=mdaRegimenRadios]").attr("disabled",!1),$("#inputScenarioLabel").attr("disabled",!1).val("Scenario "+(a+1))),5==$("input[name=mdaRegimenRadios]:checked").val()?$("#custom-regimen-sliders").show():$("#custom-regimen-sliders").hide()}function setmodelParams(e){null==e&&(e=!1);var a=ScenarioIndex.getIndex(),t=SessionData.retrieveSession(),s=t.scenarios[a].params.inputs;return $("#inputScenarioLabel").val(t.scenarios[a].label),$("#inputMDARounds").val(s.mda),$("#MDACoverage").slider("setValue",+s.coverage),$("#bedNetCoverage").slider("setValue",+s.covN),$("#sysAdherence").val(s.rho),$("#insecticideCoverage").slider("setValue",+s.v_to_hR),$("input:radio[name=mdaSixMonths]").filter("[value="+s.mdaSixMonths+"]").prop("checked",!0),$("input:radio[name=mdaRegimenRadios]").filter("[value="+s.mdaRegimen+"]").prop("checked",!0),$("#Microfilaricide").slider("setValue",+s.microfilaricide),$("#Macrofilaricide").slider("setValue",+s.macrofilaricide),{mda:$("#inputMDARounds").val(),mdaSixMonths:$("input:radio[name=mdaSixMonths]:checked").val(),endemicity:$("#endemicity").val(),coverage:$("#MDACoverage").val(),covN:$("#bedNetCoverage").val(),v_to_hR:$("#insecticideCoverage").val(),rho:$("#sysAdherence").val(),vecCap:$("#vectorialCapacity").val(),vecComp:$("#vectorialCompetence").val(),vecD:$("#vectorialDeathRate").val(),mdaRegimen:$("input[name=mdaRegimenRadios]:checked").val(),sysComp:$("#sysAdherence").val(),rhoBComp:$("#brMda").val(),rhoCN:$("#bedNetMda").val(),species:$("input[name=speciesRadios]:checked").val(),macrofilaricide:$("#Macrofilaricide").val(),microfilaricide:$("#Microfilaricide").val()}}var s=new Random;immuneRK4Step=function(e,a){var t=params.dt*(e-params.z*a),s=params.dt*(e-params.z*(a+.5*t)),r=params.dt*(e-params.z*(a+.5*s)),i=params.dt*(e-params.z*(a+r));return a+.1666667*(t+2*s+2*r+i)},L3Uptake=function(e){return 0==params.mosquitoSpecies?params.kappas1*Math.pow(1-Math.exp(-params.r1*e/params.kappas1),2):params.kappas1*(1-Math.exp(-params.r1*e/params.kappas1))},expTrunc=function(e,a){return-1/e*Math.log(1-Math.random()*(1-Math.exp(-e*a)))},poisson=function(e){var a=Math.exp(-e),t=1,s=0;do s++,t*=Math.random();while(t>a);return s-1},setBR=function(e){e?(params.lbda=params.lbdaR*params.lbda_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2):(params.lbda=params.lbda_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2)},setVH=function(e){e?(params.v_to_h=params.v_to_hR*params.v_to_h_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2):(params.v_to_h=params.v_to_h_original,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2)},setMu=function(e){params.sig=e?params.sigR:params.sig_original};var params={riskMu1:1,riskMu2:1,riskMu3:1,shapeRisk:.065,mu:.0104,theta:0,gamma:.1,alpha:.58,lbda:10,v_to_h:9,kappas1:4.395,r1:.055,tau:.00167,z:0,nu:0,L3:0,g:.37,sig:5,psi1:.414,psi2:.32,dt:1,lbdaR:1,v_to_hR:1,nMDA:5,mdaFreq:12,covMDA:.65,s2:.00275,mfPropMDA:.05,wPropMDA:.45,rho:0,mosquitoSpecies:0,rhoBU:0,aWol:0,sigR:5,covN:0,sysCompN:.99,rhoCN:0,IDAControl:0};params.lbda_original=params.lbda,params.v_to_h_original=params.v_to_h,params.sig_original=params.sig,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2,params.a=params.shapeRisk,params.b=1/params.a,params.sN=.03,params.dN=.41,params.sigma=params.rho/(1-params.rho),params.u0=-NormSInv(params.covMDA)*Math.sqrt(1+params.sigma),setPropMDA=function(e){ps=modelParams(),chis=[.99,.95,.99,1,+ps.microfilaricide/100],taus=[.35,.55,.1,1,+ps.macrofilaricide/100],params.mfPropMDA=1-chis[+e-1],params.wPropMDA=1-taus[+e-1]},closest=function(e,a){for(var t,s=0,r=a.length-1;r-s>1;)t=Math.floor((s+r)/2),a[t]<e?s=t:r=t;return e-a[s]>a[r]-e?r:s},setVHFromPrev=function(e,a){var t=[5,5.55555556,6.11111111,6.66666667,7.22222222,7.77777778,8.33333333,8.88888889,9.44444444,10],s=[4,4.55555556,5.11111111,5.66666667,6.22222222,6.77777778,7.33333333,7.88888889,8.44444444,9],r=[.09405936,.09882859,.11038997,.11982386,.12751358,.13604286,.14459468,.15150072,.15736517,.16302997],o=[.09306863,.11225442,.1267763,.13999753,.15040748,.16114762,.16863057,.17532108,.1827041,.18676246];if(0===a)var n=t,l=r;else var n=s,l=o;return i=closest(e,l),n[i]},setInputParams=function(e){ps=modelParams(),params.inputs=ps,params.nMDA=e.nMDA?e.nMDA:+ps.mda,params.mdaFreq="True"===ps.mdaSixMonths?6:12;var a=e.endemicity?e.endemicity/100:ps.endemicity/100,t=ps.species;params.v_to_h=+setVHFromPrev(a,+t),params.covMDA=+(ps.coverage/100),params.covN=+(ps.covN/100),params.v_to_hR=1-+(ps.v_to_hR/100),params.vecCap=+ps.vecCap,params.vecComp=+ps.vecComp,params.vecD=+ps.vecD,setPropMDA(+ps.mdaRegimen),params.sysComp=+ps.sysComp,params.rhoBComp=+ps.rhoBComp,params.rhoCN=+ps.rhoCN,params.species=+ps.species,params.shapeRisk=0==params.species?.065:.08,params.lbda_original=params.lbda,params.v_to_h_original=params.v_to_h,params.sig_original=params.sig,params.xi=params.lbda*params.v_to_h*params.psi1*params.psi2*params.s2,params.a=params.shapeRisk,params.b=1/params.a,params.sigma=params.rho/(1-params.rho),params.u0=-NormSInv(params.covMDA)*Math.sqrt(1+params.sigma)},plot=function(e,a,t,s){a.unshift("worm_burden"),t.unshift("mf_burden"),s.unshift("L3"),e.unshift("tx"),c3.generate({bindto:"#chart",data:{xs:{worm_burden:"tx",mf_burden:"tx",L3:"tx"},columns:[e,a,t,s],names:{worm_burden:"Worm burden",mf_burden:"mf burden",L3:"L3 density"}},axis:{x:{label:"time (years)",tick:{fit:!1}},y:{label:"Prevalence",min:0}},legend:{position:"right"},zoom:{enabled:!0},type:"spline"})};var layout={title:"Time-series",xaxis:{title:"Time since start of intervention (yrs)",showgrid:!1,zeroline:!1},yaxis:{title:"Prevalence",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}};$(document).ready(function(){tabCounter=1,roundsScenarioCounter=1,$("#set-mda-regimen").click(function(){$("#mda-table-box .alert").alert("close");var e=$("#mda-form").html(),a=$("#coverage-form").html().replace("%",""),t=!1;if("IVM + ALB"==e)$("#mdaRegimenRadios1").prop("checked",!0);else if("DEC + ALB"==e)$("#mdaRegimenRadios2").prop("checked",!0);else{var s=$("#new-alert").html(),r=modelParams();$("#mda-table-box").append(s),$("#mda-table-box .alert").addClass("alert-warning").append("<strong> Warning! </strong> MDA regimen was not set. Current regimen is "+mdaDrugName(r.mdaRegimen)+". See settings -> MDA tab for details."),t=!0}if($("#MDACoverage").slider("setValue",+a),0==t){var s=$("#new-alert").html();$("#mda-table-box").append(s),$("#mda-table-box .alert").addClass("alert-success").append("<strong> Success! </strong> MDA parameters set. See settings -> MDA tab for details.")}}),$("#test-data").click(function(){if(paramSummary(),$("#pleaseWaitDialog").modal("show"),$("#model #mutliSimCheckBox").prop("checked"))$("#model #multiSimLoading").show(),multiSimCompute();else{setInputParams();var e=new Model(800);e.evolveAndSaves(120),console.log("No. rounds: ",e.nRounds());var a={x:e.ts,y:e.Ms,type:"scatter",name:"microfilariaemia"},t={x:e.ts,y:e.Ws,type:"scatter",name:"antigenaemia"},s={x:e.ts,y:e.Ls,type:"scatter",name:"mosquito"},r=[a,t,s];layout.title="Time Series",Plotly.newPlot("plotlyChart",r,layout,{displayModeBar:!1}),$("#pleaseWaitDialog").modal("hide")}}),$("#reset-rounds").click(function(){Plotly.newPlot("boxplotChart",[]),roundsScenarioCounter=1,$("#rounds-scenario-accordion").html("")}),$("#run-rounds").click(function(){$("#rounds-progress-bar").show(),$("#roundsTest").show(),$("#rounds-progress-bar-bar").css("width","100%").attr("aria-valuenow",100),$("#rounds-progress-bar").css("width","0%"),setInputParams(),params.nMDA=40;var e=$("#roundSims").val(),a=[],t=0,s=setInterval(function(){$("#rounds-progress-bar").css("width",+(100*t/e)+"%");var r=new Model(800);if(r.evolveAndSaves(120),a.push(r.nRounds()),$("#roundsTest").html(100*t/e+"%"),t==e){$("#rounds-progress-bar").hide(),$("#roundsTest").hide(),clearInterval(s);var i={title:"No. rounds to below 1% microfilariaemia",xaxis:{title:"",showgrid:!1,zeroline:!1},yaxis:{title:"No. rounds",showline:!1,rangemode:"tozero",autorange:!0,zeroline:!0}},o={y:a,type:"box",name:"scenario "+roundsScenarioCounter};1==roundsScenarioCounter?Plotly.newPlot("boxplotChart",[o],i,{displayModeBar:!1}):Plotly.addTraces("boxplotChart",[o]),roundsScenarioCounter+=1}else t+=1},10),r=$("#new-scenario-accordian").html();$("#rounds-scenario-accordion").append(r),$("#rounds-scenario-accordion #headingOne").attr("id","heading"+roundsScenarioCounter),$("#rounds-scenario-accordion #heading"+roundsScenarioCounter+" a").attr("href","#collapse"+roundsScenarioCounter).attr("aria-controls","collapse"+roundsScenarioCounter).html("Scenario "+roundsScenarioCounter),$("#rounds-scenario-accordion #collapseOne").attr("id","collapse"+roundsScenarioCounter),$("#collapse"+roundsScenarioCounter).attr("aria-labelledby","heading"+roundsScenarioCounter),$("#collapse"+roundsScenarioCounter+" .panel-body").html(paramSummaryText(!0))}),$("#home a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#vector a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#mda a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#rounds a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#model a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#adherence a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#test a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#plus").click(function(){var e=$("<div role='tabpanel' class='tab-pane' id='model"+tabCounter+"'></div>"),a=$("#new-tab").html();$(".tab-content").append(e),$("div.tab-pane#model"+tabCounter).html(a);var t=$("<li role='presentation' "+tabCounter+"><a href='#model"+tabCounter+"' aria-controls='model' role='tab' data-toggle='tab'><button class='close closeTab' type='button' >x</button>Scenario "+tabCounter+" </a></li>");$("#nav-tabs li:last").prev().after(t),$("#model"+tabCounter+" #plotlyChart").attr("id","plotlyChart"+tabCounter),$("#model"+tabCounter+" #chart_mf").attr("id","model_"+tabCounter+"_chart_mf"),$("#model"+tabCounter+" #chart_wb").attr("id","model_"+tabCounter+"_chart_wb"),$("#model"+tabCounter+" #chart_L3").attr("id","model_"+tabCounter+"_chart_L3"),$("#model"+tabCounter+" #multiSim").slider(),$("#model"+tabCounter+" #multiSimSliderDiv").hide(),$("#model"+tabCounter+" #multiSimLoading").hide(),$("#model"+tabCounter+" #mutliSimCheckBox").data("tabIndex",tabCounter),$("#model"+tabCounter+" #simulation-title").html("Scenario "+tabCounter),$("#model"+tabCounter+" #mutliSimCheckBox").bind("click",function(){var e=$(this).data().tabIndex;toggle("#model"+e+" .multiSimGroup",this),toggleOff("#model"+e+" .singleSimGroup",this)}),$("#model"+tabCounter+" #test-data").data("tabIndex",tabCounter),$("#model"+tabCounter+" #test-data").bind("click",function(){var e=$(this).data();runSimulation(e.tabIndex)}),$(".closeTab").bind("click",function(){var e=$(this).parent().attr("href");$(this).parent().parent().remove(),$("#myTab a:last").tab("show"),$(e).remove()}),$("a#model"+tabCounter+" button").data("tabIndex",tabCounter),$('.nav-tabs a[href="#model'+tabCounter+'"]').tab("show"),tabCounter++}),$("#regimen-radio").bind("click",function(){5==$("input[name=mdaRegimenRadios]:checked").val()?$("#custom-regimen-sliders").show():$("#custom-regimen-sliders").hide()}),$("#custom-regimen-sliders").hide(),$("#Macrofilaricide").slider({}),$("#Microfilaricide").slider({}),$("#brMda").slider({}),$("#sysAdherence").slider({}),$("#bedNetMda").slider({}),$("#endemicity").slider({formatter:function(e){return e+"%"}}),$("#roundSims").slider({}),$("#MDACoverage").slider({formatter:function(e){return e+"%"}}),$("#bedNetCoverage").slider({formatter:function(e){return e+"%"}}),$("#insecticideCoverage").slider({formatter:function(e){return e+"%"}}),$("#multiSim").slider(),$("#vectorialCapacity").slider(),$("#vectorialCompetence").slider(),$("#vectorialDeathRate").slider(),$("#multiSimSliderDiv").hide(),$("#multiSimLoading").hide(),$("#rounds-progress-bar").hide(),$("#termsModal").modal({show:!0,backdrop:"static",keyboard:!1})});var glob_data,glob_prevs;SessionData.storeResults=function(e,a){var t=JSON.parse(localStorage.getItem("sessionDataEthiopia"));(null==t||null==t.scenarios)&&(t={scenarios:[]}),null==a&&(a="Scenario "+(ScenarioIndex.getIndex()+1));var s={params:params,results:e,label:a},r=ScenarioIndex.getIndex();return t.scenarios[r]=s,toStore=JSON.stringify(t),localStorage.setItem("sessionDataEthiopia",toStore),t},SessionData.storeStats=function(e){var a=JSON.parse(localStorage.getItem("sessionDataEthiopia")),t=ScenarioIndex.getIndex();a.scenarios[t].stats=e,toStore=JSON.stringify(a),localStorage.setItem("sessionDataEthiopia",toStore)},SessionData.createNewSession=function(){var e=JSON.parse(localStorage.getItem("sessionDataEthiopia"));(null==e||null==e.scenarios)&&(e={scenarios:[]});var a={params:params,results:[]},t=ScenarioIndex.getIndex();e.scenarios[t]=a,toStore=JSON.stringify(e)},SessionData.deleteSession=function(){localStorage.setItem("sessionDataEthiopia",null)},SessionData.retrieveSession=function(){var e=JSON.parse(localStorage.getItem("sessionDataEthiopia"));return e&&e.scenarios&&e.scenarios[0]&&e.scenarios[0].label?e:(e={scenarios:[]},toStore=JSON.stringify(e),localStorage.setItem("sessionDataEthiopia",toStore),e)},SessionData.numScenarios=function(){var e=SessionData.retrieveSession();return null==e||null==e.scenarios?0:e.scenarios.length},SessionData.convertRun=function(e,a){return{ts:e.ts,Ms:e.Ms,Ws:e.Ws,reductionYears:e.reductionYears(),nRounds:e.nRounds(),endemicity:a}
},SessionData.nRounds=function(e){for(var a=SessionData.retrieveSession(),t=a.scenarios[e],s=t.results.length,r=[],i=0;s>i;i++)r.push(t.results[i].nRounds);return r},SessionData.reductions=function(e,a,t){var s=SessionData.retrieveSession(),r=s.scenarios[e],i=r.results.length;red=0;for(var o=0,n=0;i>n;n++)t?r.results[n].endemicity==t&&(red+=r.results[n].reductionYears[a],o+=1):(red+=r.results[n].reductionYears[a],o+=1);return red/o},SessionData.ran=function(e){var a=SessionData.retrieveSession();if(!a)return!1;if(!a.scenarios[e])return!1;var t=a.scenarios[e].results;return t.length>0?!0:!1},SessionData.deleteScenario=function(){var e=ScenarioIndex.getIndex(),a=SessionData.retrieveSession();a.scenarios.splice(e,1);var t=JSON.stringify(a);localStorage.setItem("sessionDataEthiopia",t),ScenarioIndex.setIndex(0)},ScenarioIndex.getIndex=function(){return+localStorage.getItem("scenarioIndex")},ScenarioIndex.setIndex=function(e){try{var a=SessionData.retrieveSession(),t=a.scenarios[e];params=t.params,$("#scenario-title").html(a.scenarios[e].label+" Overview")}catch(s){}return localStorage.setItem("scenarioIndex",e)};var quantize=d3.scale.quantize().domain([0,.04]).range(d3.range(9).map(function(e){return"q"+e+"-9"})),quantizeDoses=d3.scale.quantize().domain([0,1e5]).range(d3.range(9).map(function(e){return"q"+e+"-9"})),quantizeTAS=d3.scale.quantize().domain([0,1]).range(d3.range(2).map(function(e){return"qTAS"+e+"-1"}));$(document).ready(function(){function e(e,i,o){d3.select("#map").select("img").remove(),glob_data=i,glob_prevs=o,console.log(i.features.length+" "+glob_prevs.length),console.log(glob_data);{var n=r.selectAll("g").data(i.features).enter().append("g"),l=(d3.geo.mercator().center([40.4,9.1]).translate([a/2,t/2]),d3.geo.equirectangular().center([40.4,8]).scale(1500).translate([a/2,t/2]).precision(.1)),d=d3.geo.path().projection(l);n.append("path").attr("d",d).attr("id",function(e,a){return a}).attr("class",function(e,a){return colorIU(i.features[a].properties.endemicity,i.features[a].properties.prev,i.features[a].properties.pop,1,1,1)}).attr("data-prev",function(e,a){return a<glob_prevs.length?i.features[a].properties.prev:Math.random()}).on("mousemove",function(e,a){s.style("visibility","visible").html("<h5 class='text-center'> "+i.features[a].properties.ADMIN1+", "+i.features[a].properties.ADMIN2+", "+i.features[a].properties.ADMIN3+", prevalence : "+Math.round(100*i.features[a].properties.prev)+"%. Population size : "+numberWithCommas(Math.round(i.features[a].properties.pop))+" </h5>")}).on("mouseout",function(){s.style("visibility","hidden")})}}var a=$("#map").width(),t=350,s=d3.select("#map").append("div").style("visibility","hidden").attr("id","tooltip").html(""),r=d3.select("#map").append("svg").attr("width",a).attr("height",t);ScenarioIndex.setIndex(0),SessionData.ran(0)&&resetSlider(),createScenarioBoxes(),scenarioComparisonSelectVisibility(),drawComparisonPlot(),$("#sel-comp-stat").change(drawComparisonPlot),$("#add-new-scenario").on("click",addScenarioButton),$("#run_scenario").on("click",modalConfirmation),$("#map-progress-bar").hide(),$("#sel-stat").change(drawMap),queue().defer(d3.json,"./assets/EthiopiaSimplify.json").defer(d3.csv,"./assets/ETH_prev.csv").await(e)});
